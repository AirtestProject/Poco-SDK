"use strict";function PocoManager(e,t){this.port=t||PORT,this.poco=new Dumper(e),this.screen=new Screen(e),this.rpc_dispacher={GetSDKVersion:function(){return POCO_SDK_VERSION},Dump:this.poco.dumpHierarchy.bind(this.poco),Screenshot:this.screen.getScreen.bind(this.screen),GetScreenSize:this.screen.getPortSize.bind(this.screen),test:function(){return"test"}},console.log("registered rpc methods.",this.rpc_dispacher),this.init_server()}var AbstractNode=function(){};AbstractNode.prototype.getParent=function(){return null},AbstractNode.prototype.getChildren=function(){},AbstractNode.prototype.getAttr=function(e){var t={name:"<Root>",type:"Root",visible:!0,pos:[0,0],size:[0,0],scale:[1,1],anchorPoint:[.5,.5],zOrders:{local:0,global:0}};return t[e]},AbstractNode.prototype.setAttr=function(e,t){throw new Error("Unable to set attributes "+e+" on this node. (NotImplemented) ")},AbstractNode.prototype.getAvailableAttributeNames=function(){return["name","type","visible","pos","size","scale","anchorPoint","zOrders"]},AbstractNode.prototype.enumerateAttrs=function(){var e={},t=this.getAvailableAttributeNames();for(var r in t){var o=t[r],n=this.getAttr(o);void 0!==n&&(e[o]=n)}return e};try{module.exports=AbstractNode}catch(e){window.module&&window.module.exports&&(window.module.exports=AbstractNode)}var DefaultMatcher=window.DefaultMatcher,ISelector=function(){};ISelector.prototype.select=function(e,t){};var Selector=function(e,t){this.dumper=e,this.matcher=t||new DefaultMatcher};Selector.prototype.getRoot=function(){return this.dumper.getRoot()},Selector.prototype.select=function(e,t){return this.selectImpl(e,t,this.getRoot(),9999,!0,!0)},Selector.prototype.selectImpl=function(e,t,r,o,n,i){var s=[];if(!r)return s;var a=e[0],c=e[1];if(">"===a||"/"===a){var p=[r];for(var d in c){d=parseInt(d);var u=c[d],h=[];for(var l in p){var m=p[l],f=o;"/"===a&&0!==d&&(f=1);var w=this.selectImpl(u,!0,m,f,n,!1);for(var v in w)h.indexOf(w[v])<0&&h.push(w[v])}p=h}s=p}else if("-"===a){var g=c[0],y=c[1],b=this.selectImpl(g,t,r,o,n,i);for(var d in b){var S=b[d],A=this.selectImpl(y,t,S.getParent(),1,n,i);for(var v in A)s.indexOf(A[v])<0&&s.push(A[v])}}else if("index"===a){var e=c[0],x=c[1];s=[this.selectImpl(e,t,r,o,n,i)[x]]}else this._selectTraverse(e,r,s,t,o,n,i);return s},Selector.prototype._selectTraverse=function(e,t,r,o,n,i,s){if(i&&!t.getAttr("visible"))return!1;if(this.matcher.match(e,t)&&s&&(r.indexOf(t)<0&&r.push(t),!o))return!0;if(0===n)return!1;n-=1;var a=t.getChildren();for(var c in t.getChildren()){var p=a[c],d=this._selectTraverse(e,p,r,o,n,i,!0);if(d)return!0}return!1};try{module.exports=Selector}catch(e){window.module&&window.module.exports&&(window.module.exports=Selector)}var Attributor=function(){};Attributor.prototype.getAttr=function(e,t){var r=e;return e.__isPocoNodeWrapper__||(r=e[0]),r.getAttr(t)},Attributor.prototype.setAttr=function(e,t,r){var o=e;e.__isPocoNodeWrapper__||(o=e[0]),o.setAttr(t,r)};try{module.exports=Attributor}catch(e){window.module&&window.module.exports&&(window.module.exports=Attributor)}var IMatcher=function(){};IMatcher.prototype.match=function(e,t){};var EqualizationComparator=function(){};EqualizationComparator.prototype.compare=function(e,t){return e===t};var RegexpComparator=function(){};RegexpComparator.prototype.compare=function(e,t){return e&&t?null!==e.toString().match(t):!1};var DefaultMatcher=function(){IMatcher.call(this),this.comparators={"attr=":new EqualizationComparator,"attr.*=":new RegexpComparator}};DefaultMatcher.prototype=Object.create(IMatcher.prototype),DefaultMatcher.prototype.match=function(e,t){var r=e[0],o=e[1];if("and"===r){for(var n in o){var i=o[n];if(!this.match(i,t))return!1}return!0}if("or"===r){for(var n in o){var i=o[n];if(this.match(i,t))return!0}return!1}var s=this.comparators[r];if(s){var a=o[0],c=o[1],p=t.getAttr(a);return s.compare(p,c)}return!1};try{module.exports=DefaultMatcher}catch(e){window.module&&window.module.exports&&(window.module.exports=DefaultMatcher)}var IScreen=function(){};IScreen.prototype.getPortSize=function(){},IScreen.prototype.getScreen=function(e){};try{module.exports=IScreen}catch(e){window.module&&window.module.exports&&(window.module.exports=IScreen)}var IDumper=function(){};IDumper.prototype.getRoot=function(){},IDumper.prototype.dumpHierarchy=function(){};var AbstractDumper=function(){IDumper.call(this)};AbstractDumper.prototype=Object.create(IDumper.prototype),AbstractDumper.prototype.dumpHierarchy=function(){return this.dumpHierarchyImpl(this.getRoot())},AbstractDumper.prototype.dumpHierarchyImpl=function(e,t){if(!e)return null;void 0===t&&(t=!0);var r=e.enumerateAttrs(),o={},n=[],i=e.getChildren();for(var s in i){var a=i[s];(!t||r.visible||a.getAttr("visible"))&&n.push(this.dumpHierarchyImpl(a,t))}return n.length>0&&(o.children=n),o.name=r.name||e.getAttr("name"),o.payload=r,o};try{module.exports=AbstractDumper}catch(e){window.module&&window.module.exports&&(window.module.exports=AbstractDumper)}var AbstractNode=window.AbstractNode,Node=function(e,t,r){AbstractNode.call(this),this.node=e,this.screenWidth=t,this.screenHeight=r};Node.prototype=Object.create(AbstractNode.prototype),Node.prototype.getParent=function(){var e=this.node.parent;return e?new Node(e,this.screenWidth,this.screenHeight):null},Node.prototype.getChildren=function(){var e=null,t=this.node.$children;if(t){e=[];for(var r in t){var o=t[r];e.push(new Node(o,this.screenWidth,this.screenHeight))}}return e},Node.prototype.getAttr=function(e){if("visible"===e){if(this.node.$visible){for(var t=this.node.parent;t;){if(!t.$visible)return!1;t=t.parent}return!0}return!1}if("name"===e)return this.node.name?this.node.name:this.node.__class__;if("text"===e)return this.node.text;if("type"===e){var r=this.node.__class__.toString();return r}if("pos"===e){var o=0,n=0,i=this.node.localToGlobal();if(this.node.__class__.toString().startsWith("eui")){var s=this.node.width,a=this.node.height;o=(i.x+s/2)/this.screenWidth,n=(i.y+a/2)/this.screenHeight}else o=i.x/this.screenWidth,n=i.y/this.screenHeight;return[o,n]}if("size"===e){var c=0,p=0;return c=this.node.width,p=this.node.height,c/=this.screenWidth,p/=this.screenHeight,[c,p]}if("scale"===e)return[this.node.$scaleX,this.node.$scaleY];if("anchorPoint"===e)return this.node.__class__.toString().startsWith("eui")?[.5,.5]:[this.node.$anchorOffsetX,this.node.$anchorOffsetY];if("zOrders"===e){var d=0,u=0,t=this.node.parent,h=this.node;for(this.node.parent&&(d=this.node.parent.getChildIndex(this.node));t;)u+=t.getChildIndex(h),h=t,t=t.parent;return{local:d,global:u}}return"enabled"==e?this.node.enabled:"touchable"===e?this.node.$touchEnabled:"rotation"===e?this.node.$rotation:void 0},Node.prototype.setAttr=function(e,t){},Node.prototype.getAvailableAttributeNames=function(){return AbstractNode.prototype.getAvailableAttributeNames.call(this).concat(["enabled","touchable","rotation","text"])};try{module.exports=Node}catch(e){window.module&&window.module.exports&&(window.module.exports=Node)}var IScreen=window.IScreen,Screen=function(e){IScreen.call(this),this.root=e};Screen.prototype=Object.create(IScreen.prototype),Screen.prototype.getPortSize=function(){return[this.root.width,this.root.height]},Screen.prototype.getScreen=function(e){var t="data:image/jpeg;base64,",r=new egret.RenderTexture,o=this.getPortSize();r.drawToTexture(this.root);var n=r.toDataURL("image/jpeg",new egret.Rectangle(0,0,o[0],o[1]));return n=n.slice(t.length),[n,"jpeg"]};try{module.exports=Screen}catch(e){window.module&&window.module.exports&&(window.module.exports=Screen)}var AbstractDumper=window.AbstractDumper,Node=window.Node,Dumper=function(e){AbstractDumper.call(this),this.root=e};Dumper.prototype=Object.create(AbstractDumper.prototype),Dumper.prototype.getRoot=function(){return new Node(this.root,this.root.width,this.root.height)};try{module.exports=Dumper}catch(e){window.module&&window.module.exports&&(window.module.exports=Dumper)}var POCO_SDK_VERSION="1.0.0";try{module.exports=POCO_SDK_VERSION}catch(e){window.module&&window.module.exports&&(window.module.exports=POCO_SDK_VERSION)}var Dumper=window.Dumper,Screen=window.Screen,POCO_SDK_VERSION=window.POCO_SDK_VERSION||"0.0.0",PORT=5003;PocoManager.prototype.init_server=function(){console.log("try starting wss..");try{this.server=new WebSocket("ws://localhost:"+this.port.toString()),this.server.onopen=function(e){console.log("Network onConnection...")},this.server.onmessage=function(e){console.log("Network onMessage...");var t=new FileReader;t.onloadend=function(t){var r=t.srcElement.result;console.log(r);try{var o=JSON.parse(r),n=this.handle_request(o),i=JSON.stringify(n);this.server.send(i)}catch(s){console.log("[Poco] error when handling rpc request. req="+e.data+"\nerror message: "+s.stack)}}.bind(this),t.readAsText(e.data)},this.server.onclose=function(e){console.log("Network onDisconnection..."),console.log(JSON.stringify(e))},this.server.onerror=function(e){console.log("Network onerror..."),console.log(JSON.stringify(e))},this.server.onopen=this.server.onopen.bind(this),this.server.onmessage=this.server.onmessage.bind(this),this.server.onclose=this.server.onclose.bind(this),this.server.onerror=this.server.onerror.bind(this)}catch(e){console.log(e.stack+"\n"+e.message)}},PocoManager.prototype.handle_request=function(e){var t={id:e.id,jsonrpc:e.jsonrpc,result:void 0,error:void 0},r=e.method,o=this.rpc_dispacher[r];if(o){var n=e.params;try{var i=o.apply(this.poco,n);t.result=i}catch(s){t.error={message:s.stack}}}else t.error={message:'No such rpc method "'+r+'", reqid: '+e.id};return console.log(t),t};try{module.exports=PocoManager}catch(e){window.module&&window.module.exports&&(window.module.exports=PocoManager)}